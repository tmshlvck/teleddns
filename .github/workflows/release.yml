name: Release

on:
  push:
    tags:
      - v[0-9]+.*

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  publish-sources:
    name: Publish sources to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Build .deb packages for multiple architectures
  build-debs:
    name: Build .deb (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
          - target: aarch64-unknown-linux-gnu
            arch: arm64
          - target: armv7-unknown-linux-gnueabihf
            arch: armhf
          - target: riscv64gc-unknown-linux-gnu
            arch: riscv64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install zig
        uses: goto-bus-stop/setup-zig@v2

      - name: Install cargo-zigbuild and cargo-deb
        run: |
          cargo install cargo-zigbuild
          cargo install cargo-deb

      - name: Build with zigbuild
        run: cargo zigbuild --release --target ${{ matrix.target }}

      - name: Build .deb package
        run: cargo deb --no-build --target ${{ matrix.target }}

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: target/${{ matrix.target }}/debian/*.deb

      - name: Prepare binary for upload
        run: |
          cp target/${{ matrix.target }}/release/teleddns teleddns-${{ matrix.target }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.arch }}
          path: teleddns-${{ matrix.target }}

  # Create GitHub Release with source tarball and binaries
  github-release:
    name: Create GitHub Release
    needs: build-debs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bin-*
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            teleddns-*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to APT repository
  publish-apt:
    name: Publish to APT repo
    needs: build-debs
    runs-on: ubuntu-latest
    steps:
      - name: Download all .deb artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true

      - name: Upload and publish to APT repo
        env:
          SSH_KEY: ${{ secrets.APT_SSH_KEY }}
          SSH_HOST: ${{ secrets.APT_SSH_HOST }}
          SSH_USER: ${{ secrets.APT_SSH_USER }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan "$SSH_HOST" >> ~/.ssh/known_hosts

          # Upload and add each .deb file to the repository
          for deb in *.deb; do
            echo "Processing $deb..."
            scp "$deb" "${SSH_USER}@${SSH_HOST}:/tmp/"
            ssh "${SSH_USER}@${SSH_HOST}" "cd /srv/apt/www/teleddns && reprepro includedeb trixie /tmp/$deb && reprepro includedeb noble /tmp/$deb && rm /tmp/$deb"
          done

  # Build in Fedora COPR
  publish-copr:
    name: Build in COPR
    needs: github-release
    runs-on: ubuntu-latest
    steps:
      - name: Install copr-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install copr-cli

      - name: Configure copr-cli
        run: |
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = ${{ secrets.COPR_LOGIN }}
          username = tmshlvck
          token = ${{ secrets.COPR_TOKEN }}
          copr_url = https://copr.fedorainfracloud.org
          EOF

      - name: Submit COPR build
        run: |
          # Submit build using spec file URL - COPR downloads sources and builds with network
          SPEC_URL="https://raw.githubusercontent.com/tmshlvck/teleddns/${GITHUB_REF_NAME}/teleddns.spec"
          copr-cli build tmshlvck/teleddns --nowait "$SPEC_URL"
