name: Release

on:
  push:
    tags:
      - v[0-9]+.*

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Validate versions and create vendored tarball
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tarball: ${{ steps.version.outputs.tarball }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Check version alignment
        run: ./scripts/check-versions.sh

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tarball=teleddns-${VERSION}-vendor.tar.gz" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify tag matches version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          CARGO_VERSION="${{ steps.version.outputs.version }}"
          if [[ "$TAG_VERSION" != "$CARGO_VERSION" ]]; then
            echo "ERROR: Tag version ($TAG_VERSION) != Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

      - name: Create vendored tarball
        run: ./scripts/create-vendor-tarball.sh .

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: vendored-tarball
          path: ${{ steps.version.outputs.tarball }}
          retention-days: 1

  # Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Create GitHub Release with vendored tarball
  github-release:
    name: Create GitHub Release
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: vendored-tarball

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ needs.prepare.outputs.tarball }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  # Publish to Launchpad PPA
  publish-ppa:
    name: Publish to Launchpad PPA
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: vendored-tarball

      - name: Publish to PPA
        uses: yuezk/publish-ppa-package@v2
        with:
          repository: tmshlvck/teleddns
          gpg_private_key: ${{ secrets.PPA_GPG_PRIVATE_KEY }}
          gpg_passphrase: ${{ secrets.PPA_GPG_PASSPHRASE }}
          tarball: ${{ needs.prepare.outputs.tarball }}
          debian_dir: debian
          deb_email: tmshlvck@gmail.com
          deb_fullname: "Tomas Hlavacek"
          series: "noble jammy"
