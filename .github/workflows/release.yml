name: Release

on:
  push:
    tags:
      - v[0-9]+.*

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Publish to crates.io
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Build .deb packages for multiple architectures
  build-debs:
    name: Build .deb (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
          - target: aarch64-unknown-linux-gnu
            arch: arm64
          - target: armv7-unknown-linux-gnueabihf
            arch: armhf
          - target: riscv64gc-unknown-linux-gnu
            arch: riscv64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install zig
        uses: goto-bus-stop/setup-zig@v2

      - name: Install cargo-zigbuild and cargo-deb
        run: |
          cargo install cargo-zigbuild
          cargo install cargo-deb

      - name: Build with zigbuild
        run: cargo zigbuild --release --target ${{ matrix.target }}

      - name: Build .deb package
        run: cargo deb --no-build --target ${{ matrix.target }}

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: target/${{ matrix.target }}/debian/*.deb

  # Create GitHub Release with .deb packages
  github-release:
    name: Create GitHub Release
    needs: build-debs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all .deb artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.deb"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

#  # Build in Fedora COPR
#  publish-copr:
#    name: Build in COPR
#    runs-on: ubuntu-latest
#    steps:
#      - name: Install copr-cli
#        run: |
#          sudo apt-get update
#          sudo apt-get install -y python3-pip
#          pip3 install copr-cli
#
#      - name: Configure copr-cli
#        run: |
#          mkdir -p ~/.config
#          cat > ~/.config/copr << EOF
#          [copr-cli]
#          login = ${{ secrets.COPR_LOGIN }}
#          username = tmshlvck
#          token = ${{ secrets.COPR_TOKEN }}
#          copr_url = https://copr.fedorainfracloud.org
#          EOF
#
#      - name: Submit COPR build
#        run: |
#          # Submit build using spec file URL - COPR downloads sources and builds with network
#          SPEC_URL="https://raw.githubusercontent.com/tmshlvck/teleddns/${GITHUB_REF_NAME}/teleddns.spec"
#          copr-cli build tmshlvck/teleddns --nowait "$SPEC_URL"
